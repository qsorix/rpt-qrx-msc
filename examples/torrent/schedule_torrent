from utils.resources import File
from utils.schedule import at, after, shell, trigger, notify, poke

create_schedule('torrent-distribution-time')
    
test_end_policy('complete', setup_phase_delay=2.0)

# east[0] will be seeding. All other hosts just download

torrent = add_resource(File('torrent', 'big-data-file.torrent'))
data    = add_resource(File('data',    'big-data-file'))

# there are W+E-1 downloading peers
create_trigger('stop-torrent', len(west+east)-1)
#create_trigger('stop-torrent', len(west+east))

tracker_schedule = [
    ('tracker', at(0), shell('xbt_tracker')),
    ('stop-tracker', trigger('stop-torrent'), shell('kill @{tracker.pid}'))
]

peer_schedule = [
    ('ctorrent', at(5), shell('ctorrent "@{torrent.path}" -X @{poke stop-torrent}', use_resources=[torrent])),
    ('poke', poke('stop-torrent'), notify('stop-torrent')),
    ('stop', trigger('stop-torrent'), shell('kill @{ctorrent.pid}'))
]

append_schedule(east[0], tracker_schedule)
east[0].use_resource(data)

for host in west + east:
    append_schedule(host, peer_schedule)

# vim: ft=python
